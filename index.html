<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f0f0f0">
    <title>TripPuff</title>
    <style>
        :root {
            --primary-color: #000;
            --secondary-color: #666;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
        }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background-color: var(--bg-color); }
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: block; }
        .container { padding: 20px; max-width: 480px; margin: 0 auto; }
        .welcome-logo { text-align: center; margin-top: 30px; }
        .logo-icon { font-size: 50px; margin-bottom: 10px; }
        .welcome-logo h1 { margin: 0; font-size: 28px; background: linear-gradient(45deg, #000, #444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .welcome-text { text-align: center; color: var(--secondary-color); margin-top: 10px; margin-bottom: 30px; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 14px; color: var(--secondary-color); margin-bottom: 6px; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; background: #fff; }
        textarea { resize: none; }

        .phone-input-wrapper { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 10px; background: #fff; overflow: hidden; }
        .phone-prefix { padding: 0 12px; color: var(--secondary-color); }
        .phone-input-wrapper input { border: none; border-radius: 0; }

        .btn-primary { width: 100%; padding: 14px; border: none; border-radius: 12px; background: var(--primary-color); color: white; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-primary:active { transform: scale(0.99); }
        .btn-danger { background: #e74c3c; }
        .btn-green { background: #2ecc71; }

        header { background: #fff; padding: 14px 16px; display: grid; grid-template-columns: 40px 1fr 40px; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 10; }
        .logo { text-align: center; font-weight: 900; font-size: 18px; }
        .help-icon { width: 36px; height: 36px; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; cursor: pointer; }
        .profile-icon { width: 36px; height: 36px; background: #fff; border: 1px solid #ddd; color: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; cursor: pointer; }
        .profile-header { display:flex; align-items:center; justify-content:space-between; gap:10px; }
        .profile-badge { background: #f0f0f0; padding: 6px 10px; border-radius: 999px; font-size: 12px; color:#333; white-space:nowrap; }
        .order-history-item { border:1px solid #eee; border-radius: 12px; padding: 12px; margin-top: 10px; cursor: pointer; background:#fff; }
        .order-history-item:active { transform: scale(0.99); }
        .order-history-top { display:flex; justify-content:space-between; align-items:center; gap:10px; }
        .order-status-pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; background:#f3f3f3; color:#333; white-space:nowrap; }
        .order-details-list { margin-top: 10px; font-size: 14px; }
        .order-details-list div { margin-top: 6px; }

        .search-bar { padding: 14px 16px; background: #fff; position: sticky; top: 64px; z-index: 9; border-bottom: 1px solid #eee; }
        .search-bar input { border-radius: 999px; padding: 12px 14px; }
        .category-filter { padding: 10px 16px; display: flex; gap: 8px; overflow-x: auto; background: #fff; border-bottom: 1px solid #eee; }
        .cat-btn { padding: 8px 12px; border-radius: 999px; border: 1px solid #ddd; background: #fff; color: #333; font-size: 13px; white-space: nowrap; cursor: pointer; }
        .cat-btn.active { background: #000; color: #fff; border-color: #000; }

        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 16px; }
        .product-card { background: #fff; border-radius: 16px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .product-image { width: 100%; aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; background: #eee; display: flex; align-items: center; justify-content: center; }
        .product-image img { width: 100%; height: 100%; object-fit: cover; }
        .product-name { margin-top: 10px; font-weight: 800; font-size: 14px; }
        .product-price { margin-top: 6px; font-weight: 900; font-size: 16px; }
        .product-description { margin-top: 6px; font-size: 12px; color: #666; min-height: 30px; }
        .add-to-cart-btn { margin-top: auto; background: #000; color: #fff; border: none; border-radius: 12px; padding: 10px; font-weight: 800; cursor: pointer; }
        .add-to-cart-btn:active { transform: scale(0.99); }

        .qty-control-catalog { margin-top: auto; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .qty-control-catalog button { width: 36px; height: 36px; border-radius: 10px; border: 1px solid #ddd; background: #fff; font-weight: 900; cursor: pointer; }
        .in-cart-text { font-size: 11px; color: #777; }
        .out-of-stock { margin-top: auto; padding: 10px; border-radius: 12px; background: #f2f2f2; color: #888; text-align: center; font-weight: 800; }

        .modal { display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 1000; align-items: center; justify-content: center; padding: 16px; }
        .modal.active { display:flex; }
        .modal-content { background: #fff; border-radius: 16px; padding: 18px; width: 100%; max-width: 480px; max-height: 85vh; overflow: auto; position: relative; }
        .close-btn { position: absolute; right: 12px; top: 10px; font-size: 28px; cursor: pointer; color: #999; }

        .cart-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; border-bottom: 1px solid #eee; padding: 10px 0; }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-title { font-weight: 800; }
        .cart-item-price { font-size: 13px; color: #666; margin-top: 3px; }
        .cart-controls { display: flex; align-items: center; gap: 8px; }
        .qty-btn { width: 34px; height: 34px; border-radius: 10px; border: 1px solid #ddd; background: #fff; font-weight: 900; cursor: pointer; }
        .cart-total { margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; font-weight: 900; display: flex; justify-content: space-between; font-size: 16px; }

        .admin-fab { display:none; position: fixed; right: 16px; bottom: 90px; width: 54px; height: 54px; border-radius: 50%; background: #000; color: #fff; font-size: 24px; align-items:center; justify-content:center; cursor:pointer; z-index: 20; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .cart-fab { position: fixed; right: 16px; bottom: 20px; width: 54px; height: 54px; border-radius: 50%; background: #000; color: #fff; font-size: 24px; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index: 20; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .cart-badge { position: absolute; top: -6px; right: -6px; width: 22px; height: 22px; border-radius: 50%; background: #e74c3c; color: #fff; font-size: 12px; display:flex; align-items:center; justify-content:center; font-weight: 900; }

        /* ADMIN */
        .admin-tabs { display:flex; gap: 8px; margin: 10px 0 14px; }
        .admin-tab { flex: 1; padding: 10px; border: 1px solid #ddd; background: #fff; border-radius: 12px; cursor: pointer; font-weight: 800; font-size: 13px; }
        .admin-tab.active { background: #000; color: #fff; border-color: #000; }
        .admin-tab-content { display:none; }
        .admin-tab-content.active { display:block; }
        .order-admin-card { background:#f7f7f7; border-radius: 12px; padding: 12px; margin-bottom: 10px; }

        .db-table-container { overflow-x: auto; margin-top: 10px; background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 5px; }
        .db-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .db-table th, .db-table td { padding: 8px; border: 1px solid #ddd; text-align: left; white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis;}
        .db-table th { background: #f0f0f0; }
        .db-action-btn { border: none; background: none; cursor: pointer; font-size: 16px; margin-right: 5px; }

        /* PHOTO WIZARD */
        .wiz-card {
            border: 2px dashed #999; border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            background: #fff; cursor: pointer; transition: 0.2s; position: relative;
        }
        .wiz-card:active { transform: scale(0.98); background: #f0f0f0; }
        .wiz-img { width: 100%; height: 120px; background: #eee; border-radius: 8px; margin-bottom: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .wiz-img img { width: 100%; height: 100%; object-fit: cover; }
        .wiz-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); color: white; display: none;
            align-items: center; justify-content: center; border-radius: 12px;
            font-weight: bold; font-size: 18px;
        }
        .wiz-card.uploading .wiz-overlay { display: flex; }
    </style>
</head>
<body>
    <div id="registration-screen" class="screen active">
        <div class="container">
            <div class="welcome-logo"><div class="logo-icon">‚úàÔ∏èüí®</div><h1>TripPuff</h1></div>
            <p class="welcome-text">–ü–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã –∑–∞ –ø–æ–∫—É–ø–∫–∏!</p>
            <div class="form-group"><label>–ò–º—è</label><input type="text" id="name" required></div>
            <div class="form-group"><label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label><div class="phone-input-wrapper"><span class="phone-prefix">+7</span><input type="tel" id="phone" placeholder="(900) 000-00-00" maxlength="10"></div></div>
            <button class="btn-primary" onclick="registerUser()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <header><div class="profile-icon" onclick="openProfile()">üë§</div><div class="logo">TripPuff</div><div class="help-icon" onclick="openFAQ()">?</div></header>

        <div id="catalog-tab" class="tab-content active">
            <div class="search-bar"><input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." oninput="filterProducts()"></div>
            <div class="category-filter" id="category-filter">
                <button class="cat-btn active" onclick="setCategory('all')">–í—Å–µ</button><button class="cat-btn" onclick="setCategory('–ñ–∏–¥–∫–æ—Å—Ç–∏')">–ñ–∏–¥–∫–æ—Å—Ç–∏</button><button class="cat-btn" onclick="setCategory('–û–¥–Ω–æ—Ä–∞–∑–∫–∏')">–û–¥–Ω–æ—Ä–∞–∑–∫–∏</button><button class="cat-btn" onclick="setCategory('–°–Ω—é—Å')">–°–Ω—é—Å</button><button class="cat-btn" onclick="setCategory('POD-—Å–∏—Å—Ç–µ–º—ã')">POD-—Å–∏—Å—Ç–µ–º—ã</button><button class="cat-btn" onclick="setCategory('–ö–∞—Ä—Ç—Ä–∏–¥–∂–∏')">–ö–∞—Ä—Ç—Ä–∏–¥–∂–∏</button>
            </div>
            <div id="products-container" class="products-grid"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div></div>
        </div>

        <div id="admin-fab" class="admin-fab" onclick="openAdminPanel()">ü§ñ</div>
        <div class="cart-fab" onclick="openCart()">üõí<div id="cart-badge" class="cart-badge" style="display:none">0</div></div>
    </div>

    <!-- MODALS -->
    <div id="faq-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeModal('faq-modal')">&times;</span><h2>–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h2><div id="faq-content"></div></div></div>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('cart-modal')">&times;</span>
            <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>

            <div id="cart-items-container"></div>

            <div style="margin-top:12px; padding:12px; border:1px solid #eee; border-radius:12px;">
                <div style="font-weight:700; margin-bottom:8px;">–ü—Ä–æ–º–æ–∫–æ–¥</div>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="promo-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:10px; text-transform:uppercase;">
                    <button class="btn-primary" style="width:auto; padding:10px 14px; margin:0;" onclick="applyPromo()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
                <div id="promo-status" style="margin-top:8px; font-size:13px; color:#666;"></div>
                <button id="promo-clear-btn" class="btn-primary btn-danger" style="display:none; margin-top:10px; background:#999;" onclick="clearPromo()">–£–±—Ä–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
            </div>

            <div class="cart-total" style="margin-top:14px; display:block;">
                <div style="display:flex; justify-content:space-between; margin-bottom:6px;"><span>–°—É–º–º–∞:</span><span id="cart-subtotal">0 ‚ÇΩ</span></div>
                <div id="cart-promo-row" style="display:none; justify-content:space-between; margin-bottom:6px;"><span>–°–∫–∏–¥–∫–∞ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É:</span><span id="cart-promo-discount">-0 ‚ÇΩ</span></div>
                <div style="display:flex; justify-content:space-between; font-size:18px; font-weight:800;"><span>–ò—Ç–æ–≥–æ:</span><span id="cart-total-price">0 ‚ÇΩ</span></div>
                <div id="cart-old-total" style="display:none; text-align:right; margin-top:6px; color:#999; text-decoration:line-through;"></div>
            </div>

            <button class="btn-primary" onclick="startCheckout()" style="margin-top:20px;">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>

    <div id="age-warning-modal" class="modal"><div class="modal-content" style="text-align: center;"><div style="font-size: 40px; margin-bottom: 10px;">üîû</div><h2>–í–Ω–∏–º–∞–Ω–∏–µ!</h2><p>–£—á–∏—Ç—ã–≤–∞–π—Ç–µ, —á—Ç–æ –µ—Å–ª–∏ –≤–∞—à –≤–æ–∑—Ä–∞—Å—Ç –º–µ–Ω—å—à–µ 18 –ª–µ—Ç - –∫—É—Ä—å–µ—Ä –≤ –ø—Ä–∞–≤–µ –æ—Ç–∫–∞–∑–∞—Ç—å –≤–∞–º –≤ –≤—ã–¥–∞—á–µ —Ç–æ–≤–∞—Ä–∞.</p><button class="btn-primary" onclick="showAddressForm()">–í—Å—ë –ø–æ–Ω—è—Ç–Ω–æ, –º–Ω–µ –µ—Å—Ç—å 18</button><button class="btn-primary btn-danger" onclick="closeModal('age-warning-modal')" style="margin-top: 10px; background: #999;">–û—Ç–º–µ–Ω–∞</button></div></div>

    <div id="address-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('address-modal')">&times;</span>
            <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h2>

            <div id="checkout-summary" style="background:#f7f7f7; border-radius:12px; padding:12px; margin-bottom:12px; font-size:14px;"></div>

            <div class="form-group">
                <label>–°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã (–¥–æ 15% —Å—É–º–º—ã)</label>
                <input type="number" id="points-spend" min="0" value="0" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:10px;" oninput="onPointsInput()">
                <div id="points-hint" style="margin-top:6px; font-size:12px; color:#666;"></div>
            </div>

            <div class="form-group">
                <label>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                <textarea id="delivery-address" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="order-comment" rows="2"></textarea>
            </div>

            <button class="btn-primary" onclick="submitOrder()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('profile-modal')">&times;</span>
            <div class="profile-header">
                <h2 style="margin:0;">–ü—Ä–æ—Ñ–∏–ª—å</h2>
                <div class="profile-badge" id="profile-points-badge">‚≠ê 0 –±–∞–ª–ª–æ–≤</div>
            </div>

            <div style="margin-top:10px; padding:12px; border:1px solid #eee; border-radius:12px;">
                <div style="font-weight:800; font-size:16px;" id="profile-name">‚Äî</div>
                <div style="margin-top:6px; color:#666;" id="profile-phone">‚Äî</div>
            </div>

            <h3 style="margin-top:18px;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
            <div id="profile-orders-list" style="margin-top:10px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <!-- ORDER DETAILS MODAL -->
    <div id="order-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('order-details-modal')">&times;</span>
            <h2 style="margin-top:0;">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h2>
            <div id="order-details-content">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <!-- ADMIN MODAL -->
    <div id="admin-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-btn" onclick="closeModal('admin-modal')">&times;</span>
            <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
            
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('stats')">üìä –°—Ç–∞—Ç</button>
                <button class="admin-tab" onclick="switchAdminTab('orders')">üì¶ –ó–∞–∫–∞–∑—ã</button>
                <button class="admin-tab" onclick="switchAdminTab('products')">‚ûï –¢–æ–≤–∞—Ä</button>
                <button class="admin-tab" onclick="switchAdminTab('db')">üíæ –ë–î</button>
            </div>

            <!-- TAB 1: STATS -->
            <div id="admin-stats-tab" class="admin-tab-content active">
                <div id="admin-stats-container"></div>
                <h3 style="margin-top:15px">–†–∞—Å—Ö–æ–¥</h3>
                <input type="number" id="expense-amount" placeholder="–°—É–º–º–∞" style="width:100%; padding:10px; margin-bottom:5px;">
                <input type="text" id="expense-comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" style="width:100%; padding:10px; margin-bottom:5px;">
                <button class="btn-primary btn-danger" onclick="addExpense()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <!-- TAB 2: ORDERS -->
            <div id="admin-orders-tab" class="admin-tab-content">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="cat-btn active" onclick="loadAdminOrders('active')" id="btn-ord-active">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
                    <button class="cat-btn" onclick="loadAdminOrders('completed')" id="btn-ord-comp">–ê—Ä—Ö–∏–≤</button>
                </div>
                <div id="admin-orders-list"></div>
            </div>

            <!-- TAB 3: PRODUCTS -->
            <div id="admin-products-tab" class="admin-tab-content">
                <!-- IMPORT BLOCK -->
                <h3>–ò–º–ø–æ—Ä—Ç</h3>
                <textarea id="batch-json" rows="5" placeholder='–í—Å—Ç–∞–≤—å—Ç–µ JSON –º–∞—Å—Å–∏–≤ —Ç–æ–≤–∞—Ä–æ–≤...'></textarea>
                <button class="btn-primary btn-green" onclick="importBatch()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>

                <h3 style="margin-top:20px; border-top:1px solid #ccc; padding-top:10px;">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h3>
                <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input id="new-prod-name"></div>
                <div class="form-group"><label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="new-prod-cat">
                        <option>–ñ–∏–¥–∫–æ—Å—Ç–∏</option><option>–û–¥–Ω–æ—Ä–∞–∑–∫–∏</option><option>–°–Ω—é—Å</option><option>POD-—Å–∏—Å—Ç–µ–º—ã</option><option>–ö–∞—Ä—Ç—Ä–∏–¥–∂–∏</option>
                    </select>
                </div>
                <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="new-prod-desc" rows="2"></textarea></div>
                <div class="form-group"><label>–¶–µ–Ω–∞</label><input type="number" id="new-prod-price"></div>
                <div class="form-group"><label>–ó–∞–∫—É–ø</label><input type="number" id="new-prod-purch"></div>
                <div class="form-group"><label>–û—Å—Ç–∞—Ç–æ–∫</label><input type="number" id="new-prod-stock"></div>
                <div class="form-group"><label>–§–æ—Ç–æ</label><input type="file" id="new-prod-file" accept="image/*"></div>
                <button class="btn-primary btn-green" onclick="addNewProduct()">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
                
                <h3 style="margin-top:20px; border-top:1px solid #ccc; padding-top:10px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</h3>
                <div id="admin-products-list"></div>
            </div>

            <!-- TAB 4: DATABASE MANAGER -->
            <div id="admin-db-tab" class="admin-tab-content">
                <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
                    <select id="db-table-select" style="flex:1" onchange="loadDbTable()">
                        <option value="users">Users (–ö–ª–∏–µ–Ω—Ç—ã)</option>
                        <option value="faq">FAQ</option>
                        <option value="expenses">Expenses (–†–∞—Å—Ö–æ–¥—ã)</option>
                        <option value="products">Products (–¢–æ–≤–∞—Ä—ã)</option>
                        <option value="promo_codes">Promo codes (–ü—Ä–æ–º–æ–∫–æ–¥—ã)</option>
                    </select>
                    <button class="btn-primary btn-green" style="width: auto; margin:0; padding:10px;" onclick="openCreateRecordModal()">‚ûï</button>
                </div>
                <div id="db-view-container" class="db-table-container">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <!-- ADMIN EDIT ORDER MODAL -->
    <div id="edit-order-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('edit-order-modal')">&times;</span>
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ #<span id="edit-order-id-display"></span></h2>
            <input type="hidden" id="edit-order-id">

            <div class="form-group">
                <label>–ê–¥—Ä–µ—Å</label>
                <textarea id="edit-order-address" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="edit-order-comment" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>–°–∫–∏–¥–∫–∞ %</label>
                <input type="number" id="edit-order-discount" value="0" onchange="recalcEditTotal()">
            </div>

            <h3>–¢–æ–≤–∞—Ä—ã</h3>
            <div id="edit-order-items-list"></div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <select id="edit-order-add-select" style="flex:1"></select>
                <button class="btn-primary btn-green" style="width:auto; margin:0;" onclick="addItemToEditOrder()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <div style="margin-top:15px; font-weight:bold; font-size:18px;">
                –ò—Ç–æ–≥–æ: <span id="edit-order-total">0</span> ‚ÇΩ
            </div>

            <button class="btn-primary btn-danger" onclick="saveEditedOrder()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- DB EDIT MODAL -->
    <div id="db-edit-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('db-edit-modal')">&times;</span>
            <h2 id="db-edit-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
            <div id="db-edit-fields"></div>
            <button class="btn-primary" onclick="saveDbRecord()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- PHOTO WIZARD MODAL -->
    <div id="photo-wizard-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('photo-wizard-modal').classList.remove('active')">&times;</span>
            <h3>üì∏ –ú–∞—Å—Ç–µ—Ä –§–æ—Ç–æ</h3>
            <p style="font-size:14px; color:#666; margin-bottom:15px;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ. –û–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
            
            <input type="file" id="wiz-file-input" accept="image/*" style="display:none">
            <div id="wiz-grid" class="products-grid"></div>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const API_URL = 'https://ytiiiipuff-production.up.railway.app'; 
        let userData = null, products = [], cart = [], currentCategory = 'all';
        let appliedPromo = null; // {code, discount_percent}
        let pointsToSpend = 0;
        let currentEditItems = []; 
        let currentDbTable = '', currentDbId = null;

        const phoneInput = document.getElementById('phone');
        phoneInput.addEventListener('input', function(e) { this.value = this.value.replace(/\D/g, ''); });

        async function initApp() {
            try {
                const initData = Telegram.WebApp.initDataUnsafe;
                const userId = initData?.user?.id;
                // const userId = 123456789; // Debug
                if (!userId) { alert('–û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram!'); return; }

                Telegram.WebApp.expand();
                Telegram.WebApp.setHeaderColor('#e0e0e0');

                userData = await checkUserRegistration(userId);

                if (userData) {
                    showMainScreen();
                    await refreshUserData();
                    await fetchCart();
                    await loadCatalog();
                    if (userData.is_admin) document.getElementById('admin-fab').style.display = 'flex';
                } else {
                    showRegistrationScreen();
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function refreshUserData() {
            if (!userData?.telegram_id) return;
            try {
                const res = await fetch(`${API_URL}/api/user/${userData.telegram_id}`);
                if (res.ok) userData = await res.json();
            } catch (e) {}
        }

        async function checkUserRegistration(userId) {
            try {
                const res = await fetch(`${API_URL}/api/user/${userId}`);
                if (res.ok) return await res.json();
            } catch (e) {}
            return null;
        }

        function showRegistrationScreen() {
            document.getElementById('registration-screen').classList.add('active');
            document.getElementById('main-screen').classList.remove('active');
        }

        function showMainScreen() {
            document.getElementById('registration-screen').classList.remove('active');
            document.getElementById('main-screen').classList.add('active');
        }

        async function registerUser() {
            const name = document.getElementById('name').value;
            let phoneVal = document.getElementById('phone').value;
            if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
            if (phoneVal.length !== 10) return alert('–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 10 —Ü–∏—Ñ—Ä');

            const fullPhone = '+7' + phoneVal;
            const tgUser = Telegram.WebApp.initDataUnsafe?.user;

            const res = await fetch(`${API_URL}/api/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: tgUser.id, name, phone: fullPhone, username: tgUser.username || '' })
            });

            const data = await res.json();
            if (data.success) {
                userData = data.user;
                showMainScreen();
                await refreshUserData();
                await fetchCart();
                await loadCatalog();
            } else {
                alert(data.message);
            }
        }

        async function fetchCart() {
            if (!userData) return;
            try {
                const res = await fetch(`${API_URL}/api/cart/${userData.telegram_id}`);
                cart = await res.json();
                updateCartBadge();
                filterProducts();
            } catch (e) {}
        }

        async function loadCatalog() {
            const container = document.getElementById('products-container');
            if (cart.length === 0) await fetchCart();

            if (products.length === 0) {
                try {
                    const res = await fetch(`${API_URL}/api/products`);
                    products = await res.json();
                    displayProducts(products);
                } catch (e) {
                    container.innerHTML = '<p>–û—à–∏–±–∫–∞</p>';
                }
            } else {
                displayProducts(products);
            }
        }

        function setCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === cat || (cat === 'all' && btn.textContent === '–í—Å–µ')) btn.classList.add('active');
            });
            filterProducts();
        }

        function filterProducts() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = products.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(term);
                const matchesCategory = currentCategory === 'all' || p.category === currentCategory;
                // –°–ö–†–´–í–ê–ï–ú –ü–£–°–¢–´–ï –¢–û–í–ê–†–´ –û–¢ –ù–ï-–ê–î–ú–ò–ù–û–í
                const isVisible = p.stock > 0 || (userData && userData.is_admin);
                return matchesSearch && matchesCategory && isVisible;
            });
            displayProducts(filtered);
        }

        function displayProducts(list) {
            const container = document.getElementById('products-container');
            container.innerHTML = '';
            if (list.length === 0) { container.innerHTML = '<div style="grid-column: 1/-1; text-align: center;">–ü—É—Å—Ç–æ</div>'; return; }

            list.forEach(p => {
                const cartItem = cart.find(c => c.product_id === p.id);
                const hasStock = p.stock > 0;

                let buttonHtml = '';
                if (!hasStock) buttonHtml = `<div class="out-of-stock">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</div>`;
                else if (cartItem) {
                    buttonHtml = `<div class="qty-control-catalog"><button onclick="changeQtyFromCatalog(${p.id}, -1)">-</button><div style="text-align:center"><div class="in-cart-text">–í –∫–æ—Ä–∑–∏–Ω–µ</div><span>${cartItem.quantity}</span></div><button onclick="changeQtyFromCatalog(${p.id}, 1)">+</button></div>`;
                } else buttonHtml = `<button class="add-to-cart-btn" onclick="addToCart(${p.id})">–í –∫–æ—Ä–∑–∏–Ω—É +</button>`;

                const el = document.createElement('div');
                el.className = 'product-card';
                el.innerHTML = `<div class="product-image">${p.image_url ? `<img src="${p.image_url}">` : '–§–æ—Ç–æ'}</div><div class="product-name">${p.name}</div><div class="product-price">${p.price} ‚ÇΩ</div><div class="product-description">${p.description}</div>${buttonHtml}`;
                container.appendChild(el);
            });
        }

        function updateCartBadge() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cart-badge');
            if (count > 0) { badge.style.display = 'flex'; badge.textContent = count; } else badge.style.display = 'none';
        }

        async function addToCart(id) {
            Telegram.WebApp.HapticFeedback.impactOccurred('light');
            try {
                await fetch(`${API_URL}/api/cart/add`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: userData.telegram_id, productId: id }) });
                await fetchCart();
            } catch (e) {}
        }

        async function changeQtyFromCatalog(id, chg) {
            if (chg === 1) await addToCart(id);
            else await removeFromCart(id);
        }

        async function removeFromCart(id, all = false) {
            try {
                await fetch(`${API_URL}/api/cart/remove`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: userData.telegram_id, productId: id, removeAll: all }) });
                await fetchCart();
                if (document.getElementById('cart-modal').classList.contains('active')) openCart();
            } catch (e) {}
        }

        function computeCartTotals() {
            const subtotal = cart.reduce((s, i) => s + (parseFloat(i.price) * parseInt(i.quantity, 10)), 0);

            const promoPercent = appliedPromo?.discount_percent ? parseInt(appliedPromo.discount_percent, 10) : 0;
            const promoDiscount = promoPercent > 0 ? subtotal * (promoPercent / 100) : 0;

            const afterPromo = Math.max(0, subtotal - promoDiscount);

            const availablePoints = parseInt(userData?.points || 0, 10);
            const maxPoints = Math.min(availablePoints, Math.floor(afterPromo * 0.15));
            const safePointsToSpend = Math.min(Math.max(0, parseInt(pointsToSpend || 0, 10)), maxPoints);

            const total = Math.max(0, afterPromo - safePointsToSpend);

            return {
                subtotal,
                promoPercent,
                promoDiscount,
                afterPromo,
                availablePoints,
                maxPoints,
                pointsToSpend: safePointsToSpend,
                total
            };
        }

        async function applyPromo() {
            const inp = document.getElementById('promo-input');
            const code = (inp.value || '').trim().toUpperCase();
            if (!code) return alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥');

            try {
                const res = await fetch(`${API_URL}/api/promo/${encodeURIComponent(code)}`);
                if (!res.ok) {
                    appliedPromo = null;
                    document.getElementById('promo-status').textContent = '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—Ç–∫–ª—é—á—ë–Ω.';
                    document.getElementById('promo-clear-btn').style.display = 'none';
                    openCart();
                    return;
                }
                const data = await res.json();
                appliedPromo = { code: data.code, discount_percent: data.discount_percent };
                document.getElementById('promo-status').textContent = `–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω: ${appliedPromo.code} (-${appliedPromo.discount_percent}%)`;
                document.getElementById('promo-clear-btn').style.display = 'block';
                openCart();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞');
            }
        }

        function clearPromo() {
            appliedPromo = null;
            const status = document.getElementById('promo-status');
            status.textContent = '';
            document.getElementById('promo-clear-btn').style.display = 'none';
            openCart();
        }

        async function openCart() {
            await fetchCart();
            document.getElementById('cart-modal').classList.add('active');

            const container = document.getElementById('cart-items-container');
            container.innerHTML = '';

            if (cart.length === 0) {
                container.innerHTML = '<p>–ü—É—Å—Ç–æ</p>';
                document.getElementById('cart-subtotal').textContent = '0 ‚ÇΩ';
                document.getElementById('cart-total-price').textContent = '0 ‚ÇΩ';
                document.getElementById('cart-promo-row').style.display = 'none';
                document.getElementById('cart-old-total').style.display = 'none';
                return;
            }

            cart.forEach(i => {
                const sum = parseFloat(i.price) * parseInt(i.quantity, 10);
                container.innerHTML += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-title">${i.name}</div>
                            <div class="cart-item-price">${i.price} x ${i.quantity} = ${sum.toFixed(2)}</div>
                        </div>
                        <div class="cart-controls">
                            <button class="qty-btn" onclick="removeFromCart(${i.product_id})">-</button>
                            <span>${i.quantity}</span>
                            <button class="qty-btn" onclick="addToCart(${i.product_id})">+</button>
                        </div>
                    </div>
                `;
            });

            // totals (–≤ –∫–æ—Ä–∑–∏–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ–º–æ; –±–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏)
            const t = computeCartTotals();
            document.getElementById('cart-subtotal').textContent = t.subtotal.toFixed(2) + ' ‚ÇΩ';

            if (t.promoPercent > 0) {
                document.getElementById('cart-promo-row').style.display = 'flex';
                document.getElementById('cart-promo-discount').textContent = '-' + t.promoDiscount.toFixed(2) + ' ‚ÇΩ';
                document.getElementById('cart-total-price').textContent = t.afterPromo.toFixed(2) + ' ‚ÇΩ';
                document.getElementById('cart-old-total').style.display = 'block';
                document.getElementById('cart-old-total').textContent = '–ë—ã–ª–æ: ' + t.subtotal.toFixed(2) + ' ‚ÇΩ';
            } else {
                document.getElementById('cart-promo-row').style.display = 'none';
                document.getElementById('cart-total-price').textContent = t.subtotal.toFixed(2) + ' ‚ÇΩ';
                document.getElementById('cart-old-total').style.display = 'none';
            }

            // status
            const status = document.getElementById('promo-status');
            if (appliedPromo?.code) status.textContent = `–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω: ${appliedPromo.code} (-${appliedPromo.discount_percent}%)`;
            else status.textContent = '';
            document.getElementById('promo-clear-btn').style.display = appliedPromo?.code ? 'block' : 'none';
        }

        function startCheckout() {
            if (cart.length === 0) return alert('–ü—É—Å—Ç–æ');
            document.getElementById('cart-modal').classList.remove('active');
            document.getElementById('age-warning-modal').classList.add('active');
        }

        function renderCheckoutSummary() {
            const t = computeCartTotals();
            const summary = document.getElementById('checkout-summary');

            let html = `<div style="display:flex; justify-content:space-between;"><span>–°—É–º–º–∞:</span><b>${t.subtotal.toFixed(2)} ‚ÇΩ</b></div>`;
            if (t.promoPercent > 0) {
                html += `<div style="display:flex; justify-content:space-between; margin-top:6px;"><span>–ü—Ä–æ–º–æ–∫–æ–¥ ${appliedPromo.code} (-${t.promoPercent}%):</span><b>-${t.promoDiscount.toFixed(2)} ‚ÇΩ</b></div>`;
                html += `<div style="display:flex; justify-content:space-between; margin-top:6px;"><span>–ü–æ—Å–ª–µ –ø—Ä–æ–º–æ:</span><b>${t.afterPromo.toFixed(2)} ‚ÇΩ</b></div>`;
            }
            html += `<div style="display:flex; justify-content:space-between; margin-top:6px;"><span>–î–æ—Å—Ç—É–ø–Ω–æ –±–∞–ª–ª–æ–≤:</span><b>${t.availablePoints}</b></div>`;
            html += `<div style="display:flex; justify-content:space-between; margin-top:6px;"><span>–ú–∞–∫—Å–∏–º—É–º —Å–ø–∏—Å–∞–Ω–∏—è:</span><b>${t.maxPoints}</b></div>`;
            html += `<div style="display:flex; justify-content:space-between; margin-top:10px; font-size:18px;"><span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span><b>${t.total.toFixed(2)} ‚ÇΩ</b></div>`;

            summary.innerHTML = html;

            // hint + normalize input
            const inp = document.getElementById('points-spend');
            inp.max = t.maxPoints;
            if (parseInt(inp.value || 0, 10) > t.maxPoints) inp.value = t.maxPoints;
            if (parseInt(inp.value || 0, 10) < 0) inp.value = 0;

            document.getElementById('points-hint').textContent =
                `–ú–æ–∂–Ω–æ —Å–ø–∏—Å–∞—Ç—å –¥–æ ${t.maxPoints} –±–∞–ª–ª–æ–≤ (–Ω–µ –±–æ–ª—å—à–µ 15% —Å—É–º–º—ã). 1 –±–∞–ª–ª = 1 ‚ÇΩ —Å–∫–∏–¥–∫–∏.`;
        }

        function onPointsInput() {
            pointsToSpend = parseInt(document.getElementById('points-spend').value || 0, 10) || 0;
            renderCheckoutSummary();
        }

        function showAddressForm() {
            document.getElementById('age-warning-modal').classList.remove('active');
            document.getElementById('address-modal').classList.add('active');

            document.getElementById('points-spend').value = pointsToSpend || 0;
            renderCheckoutSummary();
        }

        async function submitOrder() {
            const addr = document.getElementById('delivery-address').value;
            if (!addr) return alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å');

            pointsToSpend = parseInt(document.getElementById('points-spend').value || 0, 10) || 0;
            const t = computeCartTotals();
            const safePoints = Math.min(pointsToSpend, t.maxPoints);

            try {
                const res = await fetch(`${API_URL}/api/order`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        userId: userData.telegram_id,
                        address: addr,
                        comment: document.getElementById('order-comment').value,
                        promoCode: appliedPromo?.code || null,
                        pointsToSpend: safePoints
                    })
                });

                const data = await res.json();
                if (data.success) {
                    alert('–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!');
                    document.getElementById('address-modal').classList.remove('active');

                    pointsToSpend = 0;
                    document.getElementById('points-spend').value = 0;

                    await fetchCart();
                    await refreshUserData();
                } else {
                    alert(data.message || '–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è');
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è');
            }
        }

        // --- PROFILE ---
        async function openProfile() {
            document.getElementById('profile-modal').classList.add('active');
            await renderProfile();
        }

        async function renderProfile() {
            await refreshUserData();
            document.getElementById('profile-name').textContent = userData?.name || '‚Äî';
            document.getElementById('profile-phone').textContent = userData?.phone || '‚Äî';
            document.getElementById('profile-points-badge').textContent = `‚≠ê ${(userData?.points || 0)} –±–∞–ª–ª–æ–≤`;

            const list = document.getElementById('profile-orders-list');
            list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                const res = await fetch(`${API_URL}/api/orders/${userData.telegram_id}`);
                const orders = await res.json();

                if (!orders || orders.length === 0) {
                    list.innerHTML = '<div style="color:#666;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>';
                    return;
                }

                list.innerHTML = orders.map(o => {
                    const dt = new Date(o.created_at);
                    const date = dt.toLocaleDateString('ru-RU') + ' ' + dt.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                    const statusTxt = o.status === 'completed' ? '–í—ã–ø–æ–ª–Ω–µ–Ω' : '–ê–∫—Ç–∏–≤–µ–Ω';

                    let extra = '';
                    if (o.promo_code) extra += ` ‚Ä¢ üè∑Ô∏è ${o.promo_code}`;
                    if (o.points_spent && o.points_spent > 0) extra += ` ‚Ä¢ ‚≠ê -${o.points_spent}`;

                    return `
                        <div class="order-history-item" onclick="openOrderDetails(${o.id})">
                            <div class="order-history-top">
                                <div style="font-weight:800;">–ó–∞–∫–∞–∑ #${o.id}</div>
                                <div class="order-status-pill">${statusTxt}</div>
                            </div>
                            <div style="margin-top:6px; font-size:13px; color:#666;">${date}${extra}</div>
                            <div style="margin-top:8px; font-weight:800;">–ò—Ç–æ–≥–æ: ${(parseFloat(o.total_price||0)).toFixed(2)} ‚ÇΩ</div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                list.innerHTML = '<div style="color:#666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏.</div>';
            }
        }

        async function openOrderDetails(orderId) {
            document.getElementById('order-details-modal').classList.add('active');
            const c = document.getElementById('order-details-content');
            c.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                const res = await fetch(`${API_URL}/api/order/${orderId}?userId=${userData.telegram_id}`);
                if (!res.ok) { c.innerHTML = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑.'; return; }
                const o = await res.json();

                const dt = new Date(o.created_at);
                const date = dt.toLocaleDateString('ru-RU') + ' ' + dt.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                const statusTxt = o.status === 'completed' ? '–í—ã–ø–æ–ª–Ω–µ–Ω' : '–ê–∫—Ç–∏–≤–µ–Ω';

                const items = (o.items || []).map(i => {
                    const sum = parseFloat(i.price) * parseInt(i.quantity, 10);
                    return `<div style="display:flex; justify-content:space-between;"><span>${i.name} x${i.quantity}</span><b>${sum.toFixed(2)} ‚ÇΩ</b></div>`;
                }).join('');

                let discounts = '';
                if (o.promo_code) {
                    discounts += `<div style="display:flex; justify-content:space-between; margin-top:6px;"><span>–ü—Ä–æ–º–æ–∫–æ–¥ ${o.promo_code} (-${o.promo_discount_percent || 0}%):</span><b>-${parseFloat(o.promo_discount_amount||0).toFixed(2)} ‚ÇΩ</b></div>`;
                }
                if (o.points_spent && o.points_spent > 0) {
                    discounts += `<div style="display:flex; justify-content:space-between; margin-top:6px;"><span>–°–ø–∏—Å–∞–Ω–æ –±–∞–ª–ª–æ–≤:</span><b>-${parseFloat(o.points_spent).toFixed(0)} ‚ÇΩ</b></div>`;
                }

                c.innerHTML = `
                    <div style="background:#f7f7f7; border-radius:12px; padding:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="font-weight:900; font-size:16px;">–ó–∞–∫–∞–∑ #${o.id}</div>
                            <div class="order-status-pill">${statusTxt}</div>
                        </div>
                        <div style="margin-top:6px; font-size:13px; color:#666;">${date}</div>
                        <div style="margin-top:10px; font-size:13px; color:#666;">üìç ${o.address || '-'}</div>
                        <div style="margin-top:6px; font-size:13px; color:#666;">üí¨ ${o.comment || '-'}</div>
                    </div>

                    <div class="order-details-list">
                        <h3 style="margin-bottom:8px;">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</h3>
                        ${items}
                    </div>

                    <div style="margin-top:14px; padding:12px; border:1px solid #eee; border-radius:12px;">
                        <div style="display:flex; justify-content:space-between;"><span>–°—É–º–º–∞:</span><b>${parseFloat(o.subtotal || 0).toFixed(2)} ‚ÇΩ</b></div>
                        ${discounts}
                        <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:18px;"><span>–ò—Ç–æ–≥–æ:</span><b>${parseFloat(o.total_price || 0).toFixed(2)} ‚ÇΩ</b></div>
                    </div>
                `;
            } catch (e) {
                c.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞.';
            }
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        async function openFAQ() {
            document.getElementById('faq-modal').classList.add('active');
            const res = await fetch(`${API_URL}/api/faq`);
            document.getElementById('faq-content').innerHTML = (await res.json()).map(i => `<div><h3>${i.question}</h3><p>${i.answer}</p></div>`).join('');
        }

        // --- ADMIN LOGIC ---
        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`admin-${tab}-tab`).classList.add('active');
            if (tab === 'orders') loadAdminOrders('active');
            if (tab === 'products') loadAdminProducts();
            if (tab === 'db') loadDbTable();
        }

        async function openAdminPanel() {
            document.getElementById('admin-modal').classList.add('active');
            const container = document.getElementById('admin-stats-container');
            container.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            try {
                const res = await fetch(`${API_URL}/api/admin/stats?userId=${userData.telegram_id}`);
                const data = await res.json();
                let expList = data.expensesList.map(e => {
                    const d = new Date(e.created_at).toLocaleDateString('ru-RU');
                    return `<div style="margin-top:6px; font-size:13px; color:#444;">‚Ä¢ ${e.amount}‚ÇΩ ‚Äî ${e.comment || ''} <span style="color:#999;">(${d})</span></div>`;
                }).join('');
                container.innerHTML = `
                    <div style="background:#f7f7f7; padding:12px; border-radius:12px;">
                        <div><b>–í—ã—Ä—É—á–∫–∞:</b> ${data.revenue.toFixed(2)}‚ÇΩ</div>
                        <div><b>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å:</b> ${data.cogs.toFixed(2)}‚ÇΩ</div>
                        <div><b>–†–∞—Å—Ö–æ–¥—ã:</b> ${data.expenses.toFixed(2)}‚ÇΩ</div>
                        <div style="margin-top:8px; font-size:18px;"><b>–ü—Ä–∏–±—ã–ª—å:</b> ${data.netProfit.toFixed(2)}‚ÇΩ</div>
                    </div>
                    <div style="margin-top:10px;">
                        <h3 style="margin:10px 0 6px;">–†–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü</h3>
                        ${expList || '<div style="color:#666;">–ü–æ–∫–∞ –Ω–µ—Ç</div>'}
                    </div>
                `;
            } catch(e) {
                container.innerHTML = '–û—à–∏–±–∫–∞';
            }
        }

        async function addExpense() {
            const amount = document.getElementById('expense-amount').value;
            const comment = document.getElementById('expense-comment').value;
            if(!amount) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
            await fetch(`${API_URL}/api/admin/expense`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ userId: userData.telegram_id, amount, comment }) });
            openAdminPanel();
        }

        async function loadAdminOrders(status) {
            document.getElementById('btn-ord-active').classList.toggle('active', status === 'active');
            document.getElementById('btn-ord-comp').classList.toggle('active', status === 'completed');
            
            const container = document.getElementById('admin-orders-list');
            container.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                const res = await fetch(`${API_URL}/api/admin/orders?userId=${userData.telegram_id}&status=${status}`);
                const orders = await res.json();
                
                if(orders.length === 0) { container.innerHTML = '–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤'; return; }

                container.innerHTML = orders.map(o => {
                    const items = o.items.map(i => `${i.name} x${i.quantity}`).join(', ');
                    const date = new Date(o.created_at).toLocaleDateString('ru-RU');

                    let promoInfo = '';
                    if (o.promo_code) promoInfo += `<div style="margin-top:4px; font-size:13px; color:#555;">üè∑Ô∏è –ü—Ä–æ–º–æ–∫–æ–¥: <b>${o.promo_code}</b> (-${o.promo_discount_percent || 0}%)</div>`;
                    if (o.points_spent && parseInt(o.points_spent,10) > 0) promoInfo += `<div style="margin-top:4px; font-size:13px; color:#555;">‚≠ê –°–ø–∏—Å–∞–Ω–æ –±–∞–ª–ª–æ–≤: <b>${o.points_spent}</b></div>`;

                    let buttons = '';
                    if (status === 'active') {
                        const itemsJson = encodeURIComponent(JSON.stringify(o.items));
                        buttons = `
                            <button class="btn-primary btn-danger" style="margin-top: 5px; padding: 8px;" 
                                onclick="editOrder(${o.id}, '${o.address.replace(/\n/g,' ')}', '${(o.comment||'').replace(/\n/g,' ')}', '${itemsJson}', ${o.total_price})">
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button class="btn-green" style="margin-top:5px; padding:10px; width:100%; border:none; border-radius:5px; color:white; font-weight:bold; cursor:pointer;" onclick="completeOrder(${o.id})">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>
                        `;
                    }

                    const userLink = o.user_data?.username ? `<a href="https://t.me/${o.user_data?.username}" target="_blank">@${o.user_data?.username}</a>` : '';

                    return `
                        <div class="order-admin-card">
                            <div style="font-weight:bold; font-size:16px;">–ó–∞–∫–∞–∑ #${o.id} <span style="font-weight:normal; font-size:12px; color:#888;">${date}</span></div>
                            <div style="margin-top:5px;"><b>–ö–ª–∏–µ–Ω—Ç:</b> ${o.user_data?.name} ${userLink ? `(${userLink})` : ''}</div>
                            <div><b>–¢–µ–ª:</b> ${o.user_data?.phone}</div>
                            <div style="margin-top:5px; color:#444;">${items}</div>
                            ${promoInfo}
                            <div style="margin-top:6px; font-weight:bold;">–ò—Ç–æ–≥–æ: ${parseFloat(o.total_price||0).toFixed(2)} ‚ÇΩ</div>
                            <div style="margin-top:5px; background:#fff; padding:5px; border:1px solid #ddd; font-size:14px;">üìç ${o.address}</div>
                            <div style="margin-top:5px; font-size:13px; color:#666;">üí¨ ${o.comment || '-'}</div>
                            ${buttons}
                        </div>
                    `;
                }).join('');
            } catch(e) { container.innerHTML = '–û—à–∏–±–∫–∞'; console.error(e); }
        }

        async function completeOrder(id) {
            if(!confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑?')) return;
            await fetch(`${API_URL}/api/admin/order/${id}/done`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ userId: userData.telegram_id }) });
            loadAdminOrders('active');
        }

        function editOrder(id, addr, cmt, itemsEncoded, currentTotal) {
            document.getElementById('edit-order-id').value = id;
            document.getElementById('edit-order-id-display').textContent = id;
            document.getElementById('edit-order-address').value = addr;
            document.getElementById('edit-order-comment').value = cmt;
            document.getElementById('edit-order-discount').value = 0;

            try { currentEditItems = JSON.parse(decodeURIComponent(itemsEncoded)); } catch(e) { currentEditItems = []; }
            renderEditItems();
            recalcEditTotal();

            const select = document.getElementById('edit-order-add-select');
            select.innerHTML = products.map(p => `<option value="${p.id}">${p.name} (${p.price}‚ÇΩ)</option>`).join('');

            document.getElementById('edit-order-modal').classList.add('active');
        }

        function renderEditItems() {
            const list = document.getElementById('edit-order-items-list');
            list.innerHTML = currentEditItems.map((item, index) => `
                <div class="edit-order-item" style="border:1px solid #eee; border-radius:12px; padding:10px; margin-top:10px;">
                    <div style="font-weight:800">${item.name}</div>
                    <div style="font-size:13px; color:#666; margin-top:4px;">${item.price}‚ÇΩ x ${item.quantity}</div>
                    <div style="display:flex; gap:10px; margin-top:8px;">
                        <button class="btn-primary" style="width:auto; margin:0; padding:8px 12px; background:#999;" onclick="changeEditQty(${index}, -1)">-</button>
                        <button class="btn-primary" style="width:auto; margin:0; padding:8px 12px; background:#999;" onclick="changeEditQty(${index}, 1)">+</button>
                        <button class="btn-primary btn-danger" style="width:auto; margin:0; padding:8px 12px;" onclick="removeEditItem(${index})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
        }

        function changeEditQty(index, delta) {
            currentEditItems[index].quantity += delta;
            if (currentEditItems[index].quantity <= 0) currentEditItems.splice(index, 1);
            renderEditItems();
            recalcEditTotal();
        }

        function removeEditItem(index) {
            currentEditItems.splice(index, 1);
            renderEditItems();
            recalcEditTotal();
        }

        function addItemToEditOrder() {
            const productId = parseInt(document.getElementById('edit-order-add-select').value, 10);
            const p = products.find(x => x.id === productId);
            if (!p) return;
            const existing = currentEditItems.find(i => i.product_id === p.id);
            if (existing) existing.quantity += 1;
            else currentEditItems.push({ product_id: p.id, name: p.name, price: p.price, quantity: 1 });
            renderEditItems();
            recalcEditTotal();
        }

        function recalcEditTotal() {
            const discountPercent = parseFloat(document.getElementById('edit-order-discount').value || 0);
            let sum = currentEditItems.reduce((s, i) => s + (parseFloat(i.price) * parseInt(i.quantity, 10)), 0);
            sum = sum - (sum * (discountPercent / 100));
            document.getElementById('edit-order-total').textContent = sum.toFixed(2);
        }

        async function saveEditedOrder() {
            const id = document.getElementById('edit-order-id').value;
            const addr = document.getElementById('edit-order-address').value;
            const cmt = document.getElementById('edit-order-comment').value;
            const total = parseFloat(document.getElementById('edit-order-total').textContent);
            try {
                const res = await fetch(`${API_URL}/api/admin/order/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ userId: userData.telegram_id, address: addr, comment: cmt, details: currentEditItems, total_price: total })
                });
                if(res.ok) { alert('–ó–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª–µ–Ω!'); document.getElementById('edit-order-modal').classList.remove('active'); loadAdminOrders('active'); } 
                else alert('–û—à–∏–±–∫–∞');
            } catch(e) { alert('–û—à–∏–±–∫–∞'); }
        }

        // --- PRODUCTS ADMIN ---
        async function importBatch() {
            const raw = document.getElementById('batch-json').value;
            if(!raw) return alert('–í—Å—Ç–∞–≤—å—Ç–µ JSON');
            let arr;
            try { arr = JSON.parse(raw); } catch(e) { return alert('JSON –Ω–µ–≤–µ—Ä–Ω—ã–π'); }
            const res = await fetch(`${API_URL}/api/admin/products/batch`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: userData.telegram_id, products: arr }) });
            const data = await res.json();
            if(data.success) { alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ' + data.count); document.getElementById('batch-json').value=''; loadAdminProducts(); }
            else alert('–û—à–∏–±–∫–∞');
        }

        async function addNewProduct() {
            const name = document.getElementById('new-prod-name').value;
            const category = document.getElementById('new-prod-cat').value;
            const description = document.getElementById('new-prod-desc').value;
            const price = document.getElementById('new-prod-price').value;
            const purchase_price = document.getElementById('new-prod-purch').value;
            const stock = document.getElementById('new-prod-stock').value;
            const file = document.getElementById('new-prod-file').files[0];
            if(!name || !price) return alert('–ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');

            const fd = new FormData();
            fd.append('userId', userData.telegram_id);
            fd.append('name', name);
            fd.append('category', category);
            fd.append('description', description || '');
            fd.append('price', price);
            fd.append('purchase_price', purchase_price || 0);
            fd.append('stock', stock || 0);
            if(file) fd.append('photo', file);

            const res = await fetch(`${API_URL}/api/admin/product`, { method:'POST', body: fd });
            const data = await res.json();
            if(data.success) {
                alert('–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω');
                document.getElementById('new-prod-name').value='';
                document.getElementById('new-prod-desc').value='';
                document.getElementById('new-prod-price').value='';
                document.getElementById('new-prod-purch').value='';
                document.getElementById('new-prod-stock').value='';
                document.getElementById('new-prod-file').value='';
                products = [];
                await loadCatalog();
                loadAdminProducts();
            } else alert('–û—à–∏–±–∫–∞');
        }

        async function loadAdminProducts() {
            const list = document.getElementById('admin-products-list');
            list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            try {
                if(products.length === 0) await loadCatalog();
                list.innerHTML = products.map(p => `
                    <div style="border:1px solid #eee; border-radius:12px; padding:10px; margin-bottom:10px; background:#fff;">
                        <div style="font-weight:900">${p.name}</div>
                        <div style="margin-top:6px; font-size:13px; color:#666;">${p.category} ‚Ä¢ ${p.price}‚ÇΩ ‚Ä¢ –û—Å—Ç–∞—Ç–æ–∫: <b>${p.stock}</b></div>
                        <div style="display:flex; gap:8px; margin-top:10px;">
                            <button class="btn-primary" style="width:auto; margin:0; padding:10px; background:#999;" onclick="changeStock(${p.id}, 1)">+1</button>
                            <button class="btn-primary" style="width:auto; margin:0; padding:10px; background:#999;" onclick="changeStock(${p.id}, -1)">-1</button>
                            <button class="btn-primary btn-danger" style="width:auto; margin:0; padding:10px;" onclick="deleteProduct(${p.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `).join('');
            } catch(e) {
                list.innerHTML = '–û—à–∏–±–∫–∞';
            }
        }

        async function changeStock(productId, change) {
            await fetch(`${API_URL}/api/admin/product/stock`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: userData.telegram_id, productId, change }) });
            products = [];
            await loadCatalog();
            loadAdminProducts();
        }

        async function deleteProduct(id) {
            if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
            await fetch(`${API_URL}/api/admin/product/${id}`, { method:'DELETE', headers:{'user-id': userData.telegram_id} });
            products = [];
            await loadCatalog();
            loadAdminProducts();
        }

        // --- DB MANAGER ---
        async function loadDbTable() {
            currentDbTable = document.getElementById('db-table-select').value;
            const container = document.getElementById('db-view-container');
            container.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            try {
                const res = await fetch(`${API_URL}/api/admin/db/${currentDbTable}?userId=${userData.telegram_id}`);
                const rows = await res.json();
                if(!Array.isArray(rows) || rows.length === 0) { container.innerHTML = '–ü—É—Å—Ç–æ'; return; }

                const cols = Object.keys(rows[0]);
                const thead = `<tr>${cols.map(c => `<th>${c}</th>`).join('')}<th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>`;
                const tbody = rows.map(r => `
                    <tr>
                        ${cols.map(c => `<td title="${(r[c] ?? '').toString().replace(/"/g,'&quot;')}">${r[c]}</td>`).join('')}
                        <td>
                            <button class="db-action-btn" onclick="openEditRecordModal(${r.id}, '${encodeURIComponent(JSON.stringify(r))}')">‚úèÔ∏è</button>
                            <button class="db-action-btn" onclick="deleteDbRecord(${r.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');

                container.innerHTML = `<table class="db-table"><thead>${thead}</thead><tbody>${tbody}</tbody></table>`;
            } catch(e) {
                container.innerHTML = '–û—à–∏–±–∫–∞';
            }
        }

        function openCreateRecordModal() {
            currentDbId = null;
            document.getElementById('db-edit-title').textContent = '–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å';
            document.getElementById('db-edit-fields').innerHTML = '';
            document.getElementById('db-edit-modal').classList.add('active');
        }

        function openEditRecordModal(id, encodedRow) {
            currentDbId = id;
            document.getElementById('db-edit-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å #' + id;
            let row;
            try { row = JSON.parse(decodeURIComponent(encodedRow)); } catch(e) { row = {}; }

            const fields = Object.keys(row).filter(k => k !== 'id');
            document.getElementById('db-edit-fields').innerHTML = fields.map(k => `
                <div class="form-group">
                    <label>${k}</label>
                    <input id="db-field-${k}" value="${(row[k] ?? '').toString().replace(/"/g,'&quot;')}">
                </div>
            `).join('');

            document.getElementById('db-edit-modal').classList.add('active');
        }

        async function saveDbRecord() {
            const container = document.getElementById('db-edit-fields');
            const inputs = container.querySelectorAll('input');
            const payload = {};
            inputs.forEach(inp => {
                const key = inp.id.replace('db-field-','');
                payload[key] = inp.value;
            });

            try {
                let res;
                if(currentDbId) {
                    res = await fetch(`${API_URL}/api/admin/db/${currentDbTable}/${currentDbId}`, { method:'PUT', headers:{'Content-Type':'application/json', 'user-id': userData.telegram_id}, body: JSON.stringify(payload) });
                } else {
                    res = await fetch(`${API_URL}/api/admin/db/${currentDbTable}`, { method:'POST', headers:{'Content-Type':'application/json', 'user-id': userData.telegram_id}, body: JSON.stringify(payload) });
                }
                if(res.ok) {
                    closeModal('db-edit-modal');
                    loadDbTable();
                } else {
                    const err = await res.json();
                    alert(err.error || '–û—à–∏–±–∫–∞');
                }
            } catch(e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        async function deleteDbRecord(id) {
            if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/db/${currentDbTable}/${id}`, {
                    method: 'DELETE',
                    headers: { 'user-id': userData.telegram_id }
                });
                if (res.ok) loadDbTable();
                else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            } catch(e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
